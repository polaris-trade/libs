#!/usr/bin/env sh
echo "‚ö° Running pre-push checks..."
echo ""

# Validate branch name
BRANCH_NAME=$(git symbolic-ref --short HEAD 2>/dev/null)
# Allowed pattern: feature/, bugfix/, hotfix/, release/, docs/, chore/, etc.
BRANCH_PATTERN="^(feature|feat|bugfix|hotfix|release|docs|chore|refactor|test|ci|staging|dev)\/[a-z0-9-]+$|^(main|master|develop|development|dev)$"

if ! echo "$BRANCH_NAME" | grep -qE "$BRANCH_PATTERN"; then
  echo "‚ùå Invalid branch name: $BRANCH_NAME"
  echo ""
  echo "Branch names must follow the pattern:"
  echo "  - feature/description"
  echo "  - bugfix/description" 
  echo "  - hotfix/description"
  echo "  - release/version"
  echo "  - docs/description"
  echo "  - chore/description"
  echo "  - refactor/description"
  echo "  - test/description"
  echo "  - ci/description"
  echo "  - main, master, develop, development, staging, dev"
  echo ""
  echo "Use lowercase letters, numbers, and hyphens only in the description."
  echo "Example: feature/add-user-authentication"
  echo "Rename your branch with: git branch -m <new-branch-name>"
  exit 1
fi

echo "üìã Running clippy..."
cargo clippy --all-targets --all-features -- -D warnings 2>&1 | grep -E "^(error|warning)" || cargo clippy --all-targets --all-features -- -D warnings || exit 1

# Optimized build and test
echo "üî® Building..."
export RUSTFLAGS="-C codegen-units=16 -C debuginfo=0"
cargo build --profile ci >/dev/null 2>&1 || { echo "‚ùå Build failed!"; cargo build --profile ci; exit 1; }

echo "üß™ Running tests..."
cargo nextest run --profile ci 2>&1 | grep -v "^\s*Compiling\|^\s*Finished\|^\s*Running" || cargo test --quiet || exit 1

echo "‚úÖ All checks passed!"
